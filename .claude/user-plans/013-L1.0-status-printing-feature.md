# Mikrotik Status Printing Feature - Design Session

**Created**: 2026-01-27
**Parent**: Plan 013 - Distributed Nix Binary Caching
**Status**: Planning - Ready for design discussion
**Branch**: `opencode`

---

## Objective

Add compact status printing capability to mikrotik-management skill for quick inspection of switch configuration state.

---

## User Requirements (2026-01-27)

**Goal**: Print switch/bridge/port/IP/DHCP/DNS status in a **compact form** within Claude Code

**Use Cases**:
1. Quick sanity check after configuration changes
2. Debugging connectivity issues
3. Verifying configuration without verbose RouterOS output
4. Status snapshot for documentation

**Scope**: Status for:
- Switch (system info, model, version)
- Bridge (name, ports, VLAN filtering status)
- Ports (assignment, status)
- IP addresses (interface, address, network)
- DHCP (server status, pool, leases)
- DNS (upstream servers, static entries)

**Format**: Compact (not verbose RouterOS CLI output)

**Integration**: May need to be a slash command that uses the skill, or a skill function

---

## Design Questions for Next Session

### 1. Integration Approach

**Option A: Slash Command** (e.g., `/mikrotik-status`)
- **Pros**:
  - Easy to invoke from Claude Code interface
  - Can be used in any context (not just when skill is active)
  - Follows existing pattern (like `/documentation`, `/security`)
- **Cons**:
  - Requires `.claude/commands/` directory structure
  - Additional file to maintain
  - Less discoverable within skill documentation

**Option B: Skill Function** (e.g., `mikrotik_status()` within skill)
- **Pros**:
  - Self-contained within skill
  - Easy to discover in SKILL.md documentation
  - Reusable in workflows (e.g., after L1.0 workflow completes)
- **Cons**:
  - Only available when skill is invoked
  - Requires user to know to invoke skill first

**Option C: Both** (slash command wraps skill function)
- **Pros**:
  - Best of both worlds
  - Slash command provides convenience
  - Skill function provides reusability
- **Cons**:
  - More code to maintain
  - Potential duplication

**Recommendation**: Start with Option B (skill function), add Option A (slash command) if needed after testing

---

### 2. Output Format

**Compact Format Examples**:

**Example A: Single-Line Summary**
```
Switch: CRS326-24G-2S+ v7.14 | Bridge: bridge-attic (8 ports) | IP: 10.0.0.1/24 | DHCP: 2 leases | DNS: 2 static
```

**Example B: Multi-Line Compact**
```
=== Mikrotik Status ===
Switch: CRS326-24G-2S+ (RouterOS 7.14)
Bridge: bridge-attic (VLAN filtering: off)
  Ports: ether1-8 (8 active)
IP: 10.0.0.1/24 on bridge-attic
DHCP: dhcp-attic (pool: 10.0.0.100-200, 2 active leases)
DNS: 1.1.1.1, 8.8.8.8 (2 static entries)
```

**Example C: Structured Table**
```
=== Mikrotik Status ===
Component     | Status    | Details
------------- | --------- | -------
Switch        | Online    | CRS326-24G-2S+ v7.14, uptime 5d 3h
Bridge        | bridge-attic | 8 ports (ether1-8), VLAN filtering: off
IP Address    | 10.0.0.1/24 | Interface: bridge-attic, network: 10.0.0.0
DHCP Server   | dhcp-attic | Pool: 10.0.0.100-200, Active: 2, Static: 1
DNS Config    | Active    | Upstream: 1.1.1.1,8.8.8.8 | Static: 2 entries
```

**Example D: Hierarchical**
```
Switch: CRS326-24G-2S+ (RouterOS 7.14, uptime 5d 3h)
└─ Bridge: bridge-attic
   ├─ VLAN Filtering: off
   ├─ Ports: 8 active
   │  ├─ ether1 (NUC NIC 1 - management)
   │  ├─ ether2 (NUC NIC 2 - data)
   │  ├─ ether3-8 (available)
   ├─ IP: 10.0.0.1/24
   ├─ DHCP: dhcp-attic
   │  ├─ Pool: 10.0.0.100-200
   │  ├─ Active Leases: 2
   │  └─ Static Leases: 1 (10.0.0.10 → nux)
   └─ DNS: 1.1.1.1, 8.8.8.8
      └─ Static: nux.attic.local → 10.0.0.10
```

**Question**: Which format is most useful? Or should we support multiple verbosity levels?

---

### 3. Implementation Strategy

**Approach 1: Parse Existing RouterOS Output**
- Use existing `ssh_exec()` commands
- Parse output from `/interface bridge print`, `/ip address print`, etc.
- Format into compact display

**Approach 2: Targeted Queries**
- Use RouterOS query filters (e.g., `count-only`, `where`)
- Query only needed information
- Minimize SSH round-trips

**Approach 3: Cached State**
- Query once, cache results
- Allow refresh when needed
- Faster for repeated status checks

**Recommendation**: Approach 2 (targeted queries) - balances simplicity and efficiency

---

### 4. Verbosity Levels

**Option A: Fixed Format** (single output style)
- Simplest to implement
- May not fit all use cases

**Option B: Verbosity Flags** (e.g., `-v`, `-vv`)
- `mikrotik_status()` - brief summary
- `mikrotik_status -v` - detailed
- `mikrotik_status -vv` - full verbose
- More flexible but more complex

**Option C: Component-Specific** (e.g., `mikrotik_status bridge`)
- `mikrotik_status` - all components (compact)
- `mikrotik_status bridge` - bridge only (detailed)
- `mikrotik_status dhcp` - DHCP only (detailed)
- Most flexible, modular design

**Recommendation**: Start with Option A (fixed format), consider Option C if useful patterns emerge

---

### 5. Error Handling

**Scenarios**:
1. SSH connection fails
2. Component not configured (e.g., no DHCP server)
3. Partial configuration (some ports not assigned)
4. RouterOS version differences

**Design Considerations**:
- Should status command fail if one component errors?
- How to display missing/unconfigured components?
- Should we distinguish between "not configured" vs "query failed"?

**Recommendation**:
- Show what's available, mark missing components as "N/A"
- Continue even if one component fails (don't abort entire status)
- Clear error messages for connection failures

---

## Proposed Implementation (Draft)

### Function Signature

```bash
mikrotik_status() {
    local component="${1:-all}"  # all, switch, bridge, ip, dhcp, dns
    local verbosity="${2:-compact}"  # compact, detailed, full

    echo "=== Mikrotik Status ==="
    echo ""

    case "$component" in
        all|switch)
            _status_switch
            ;;
    esac

    case "$component" in
        all|bridge)
            _status_bridge
            ;;
    esac

    # ... etc for each component
}

_status_switch() {
    local model=$(ssh_exec "/system routerboard get model" 2>/dev/null || echo "Unknown")
    local version=$(ssh_exec "/system resource get version" 2>/dev/null || echo "Unknown")
    local uptime=$(ssh_exec "/system resource get uptime" 2>/dev/null || echo "Unknown")

    echo "Switch: $model (RouterOS $version, uptime $uptime)"
}

_status_bridge() {
    local bridge_name="${1:-bridge-attic}"  # Default or query first bridge

    local exists=$(ssh_exec "/interface bridge print count-only where name=$bridge_name" 2>/dev/null)
    if [ "$exists" = "0" ]; then
        echo "Bridge: Not configured"
        return 1
    fi

    local vlan_filtering=$(ssh_exec "/interface bridge get $bridge_name vlan-filtering" 2>/dev/null || echo "unknown")
    local port_count=$(ssh_exec "/interface bridge port print count-only where bridge=$bridge_name" 2>/dev/null || echo "0")

    echo "Bridge: $bridge_name"
    echo "  VLAN Filtering: $vlan_filtering"
    echo "  Ports: $port_count active"

    # List ports if detailed verbosity
    if [ "$verbosity" = "detailed" ] || [ "$verbosity" = "full" ]; then
        local ports=$(ssh_exec "/interface bridge port print where bridge=$bridge_name" 2>/dev/null)
        echo "  Port List:"
        echo "$ports" | grep -E '^\s*[0-9]+' | awk '{print "    - " $3 " (" $2 ")"}'
    fi
}

# ... similar for _status_ip, _status_dhcp, _status_dns
```

---

## Integration with Existing Skill

### Option 1: Add to SKILL.md Section 8 (New)

```markdown
## 8. Status and Monitoring Operations

### mikrotik-status - Print Compact Configuration Status

**Usage**:
```bash
mikrotik_status [component] [verbosity]

# Examples:
mikrotik_status                    # All components, compact
mikrotik_status bridge             # Bridge only, detailed
mikrotik_status all detailed       # All components, detailed
```

**Output**: See "Output Format" examples above
```

### Option 2: Add as Utility Function

Place in existing "Utility Functions" section alongside `dry_run_mode()`, `config_backup()`, etc.

---

## Testing Plan

1. **No Configuration** - Run on factory-reset switch
2. **Partial Configuration** - Run after Phase 1A (bridge + ports + IP only)
3. **Full Configuration** - Run after L1.0 complete (with DHCP + DNS)
4. **Connection Failure** - Unplug ethernet, verify error handling
5. **Large Configuration** - Test with 24 ports, multiple bridges

---

## Success Criteria

- [ ] Status function implemented in SKILL.md
- [ ] Compact output format defined and consistent
- [ ] All components (switch, bridge, port, IP, DHCP, DNS) supported
- [ ] Error handling for missing components
- [ ] Error handling for connection failures
- [ ] Works with L1.0 configuration (8-port bridge + DHCP + DNS)
- [ ] Documentation added to SKILL.md
- [ ] Example outputs provided
- [ ] (Optional) Slash command created if needed

---

## Questions for Design Session

1. **Format Preference**: Which output format (A, B, C, or D) is most useful?
2. **Integration**: Skill function only, or also create slash command?
3. **Verbosity**: Fixed format, verbosity flags, or component-specific queries?
4. **Error Handling**: Show partial status or fail fast?
5. **Default Target**: Should status auto-detect bridge name, or require explicit configuration?
6. **Extensibility**: Should status be pluggable (easy to add new components like firewall, NAT)?

---

## References

- **Skill**: `home/modules/claude-code/skills/mikrotik-management/SKILL.md`
- **L1.0 Workflow**: SKILL.md:606-778
- **Existing Validation**: SKILL.md:780-827 (verbose format - we want compact)
- **Plan 013**: `.claude/user-plans/013-distributed-nix-binary-caching.md`

---

## Next Session Prompt Template

```
Continue Plan 013 L1.0 - Design status printing feature for mikrotik-management skill.

Context: Skill v2.0.0 is complete with DHCP/DNS operations. L1.0 deployment is ready (awaiting hardware). Now we need to add compact status printing capability.

Requirements:
- Print switch/bridge/port/IP/DHCP/DNS status in compact form
- May be a slash command or skill function (need your help deciding)
- Should be quick sanity check, not verbose RouterOS output

Review: .claude/user-plans/013-L1.0-status-printing-feature.md

Questions to discuss:
1. Output format preference (single-line, multi-line, table, or hierarchical)?
2. Integration approach (skill function, slash command, or both)?
3. Verbosity levels needed (fixed, flags, or component-specific)?

Let's design the best approach for this feature.
```
