# L1.0 Mikrotik Network Setup - Implementation Plan

**Created**: 2026-01-27
**Parent Plan**: 013-distributed-nix-binary-caching.md
**Status**: Planning - Ready for execution
**Task**: L1.0 - Mikrotik network setup (using skill)

---

## User Requirements (2026-01-27)

### Network Topology Specification

- **Bridge**: Single bridge network (simplified, no VLAN tagging)
- **Ports**: First 8 ports (ether1-ether8) assigned to bridge
- **DHCP Server**: Delivering addresses in range 10.0.0.100-200
- **DNS Integration**: DHCP clients' hostnames registered with their DHCP addresses
- **Network**: 10.0.0.0/24 isolated LAN

### Design Rationale

This is a simplified approach compared to the original L1.0 specification in Plan 013:
- **Original**: Bridge with VLAN 10 interface, 2 ports (NUC dual NICs)
- **Updated**: Single flat bridge, 8 ports, includes DHCP/DNS

The updated design provides:
- Room for multiple devices (NUC + developer laptops + future expansion)
- Automatic IP assignment via DHCP (easier onboarding)
- DNS resolution for hostname-based access (e.g., `nux.attic.local`)

---

## Target Configuration State

### Phase 1A: Basic Network (Mikrotik Skill Phase 1 - Immediately Available)

```yaml
target_config_phase_1a:
  # 1. Interfaces (validation only)
  interfaces:
    validate:
      - name: "ether1"
        expected_status: "running"
      - name: "ether2"
        expected_status: "running"
      - name: "ether3"
        expected_status: "running"
      - name: "ether4"
        expected_status: "running"
      - name: "ether5"
        expected_status: "running"
      - name: "ether6"
        expected_status: "running"
      - name: "ether7"
        expected_status: "running"
      - name: "ether8"
        expected_status: "running"

  # 2. Bridge (full management)
  bridges:
    - name: "bridge-attic"
      vlan_filtering: false
      comment: "Attic server isolated network - 8 port flat bridge"

  # 3. Bridge Ports (full management)
  bridge_ports:
    - bridge: "bridge-attic"
      interface: "ether1"
      comment: "NUC NIC 1 (management)"
    - bridge: "bridge-attic"
      interface: "ether2"
      comment: "NUC NIC 2 (data)"
    - bridge: "bridge-attic"
      interface: "ether3"
      comment: "Port 3 (available)"
    - bridge: "bridge-attic"
      interface: "ether4"
      comment: "Port 4 (available)"
    - bridge: "bridge-attic"
      interface: "ether5"
      comment: "Port 5 (available)"
    - bridge: "bridge-attic"
      interface: "ether6"
      comment: "Port 6 (available)"
    - bridge: "bridge-attic"
      interface: "ether7"
      comment: "Port 7 (available)"
    - bridge: "bridge-attic"
      interface: "ether8"
      comment: "Port 8 (available)"

  # 4. IP Address (full management)
  ip_addresses:
    - address: "10.0.0.1/24"
      interface: "bridge-attic"
      comment: "Attic network gateway and DHCP server"
```

**Status**: ✅ All capabilities available in current mikrotik-management skill

---

### Phase 1B: DHCP/DNS Server (Requires Skill Enhancement)

```yaml
target_config_phase_1b:
  # 5. DHCP Server (Phase 2+ - NOT YET IMPLEMENTED IN SKILL)
  dhcp_server:
    - name: "dhcp-attic"
      interface: "bridge-attic"
      address_pool: "pool-attic"
      pool_ranges: "10.0.0.100-10.0.0.200"
      network:
        address: "10.0.0.0/24"
        gateway: "10.0.0.1"
        dns_servers: ["10.0.0.1"]  # Use Mikrotik itself as DNS
        domain: "attic.local"
      static_leases:
        - address: "10.0.0.10"
          mac_address: "XX:XX:XX:XX:XX:XX"  # NUC MAC address
          comment: "nux - Attic server"

  # 6. DNS Configuration (Phase 2+ - NOT YET IMPLEMENTED IN SKILL)
  dns_config:
    servers: ["1.1.1.1", "8.8.8.8"]  # Upstream DNS
    allow_remote_requests: true      # Allow DHCP clients to use DNS
    static_entries:
      - name: "nux.attic.local"
        address: "10.0.0.10"
        comment: "Attic cache server"
      - name: "attic.local"
        address: "10.0.0.10"
        comment: "Alias for attic server"
```

**Status**: ⚠️ DHCP and DNS operations NOT IMPLEMENTED in current skill version

**Blocking Issue**: The mikrotik-management skill (Phase 1) only implements:
- Interface validation (read-only)
- Bridge management (full CRUD)
- Bridge port assignment (full CRUD)
- IP address management (full CRUD)
- VLAN interface creation (basic)

DHCP server and DNS configuration are documented in SKILL.md as "Phase 2+ - Not Implemented".

---

## Implementation Strategy

### Phased Approach

Given the capability gap, we have two options:

#### Option A: Two-Phase Implementation (Recommended)

**Phase 1A: Basic Network (Immediate)**
1. Create bridge-attic
2. Assign ether1-ether8 to bridge
3. Add IP 10.0.0.1/24 to bridge
4. Test connectivity (manual IP assignment on clients)

**Phase 1B: DHCP/DNS (After Skill Enhancement)**
1. Extend mikrotik-management skill with DHCP operations
2. Extend mikrotik-management skill with DNS operations
3. Deploy DHCP server configuration
4. Test DHCP lease assignment and DNS resolution

**Rationale**:
- Unblock L1.1+ immediately (NUC can use static IP 10.0.0.10)
- DHCP/DNS is valuable but not blocking for Attic deployment
- Skill enhancement can proceed in parallel

#### Option B: Manual DHCP Configuration (Faster, Less Repeatable)

**Phase 1A**: Same as Option A
**Phase 1B**: Manually configure DHCP via RouterOS CLI (not via skill)
- Commands documented below
- No automation/repeatability
- Quick time-to-value

**Trade-off**: Loses the benefit of skill-based automation for future Mikrotik tasks.

---

## Option A: Detailed Implementation Plan (Recommended)

### Step 1: Execute Phase 1A - Basic Network (Today)

**Prerequisites**:
- ✅ Mikrotik skill deployed (L0.2 complete)
- ⏸️ L0.3 validation blocked (hardware not accessible)
- ✅ Plan to proceed without validation (skill commands are idempotent/safe)

**Execution**:
1. Connect laptop to Mikrotik management port
2. Configure laptop with static IP 192.168.88.50/24
3. Test connectivity: `ssh admin@192.168.88.1`
4. Run Phase 1A configuration workflow (see "Configuration Commands" below)
5. Verify bridge and ports created
6. Test connectivity: laptop with static IP 10.0.0.50/24 on ether3

**Deliverable**:
- Bridge-attic operational with 8 ports
- Switch gateway at 10.0.0.1
- NUC can be configured with static IP 10.0.0.10
- L1.1+ tasks unblocked

**Time Estimate**: 1-2 hours

---

### Step 2: Extend Mikrotik Skill - DHCP Operations (Phase 1B Prep)

**Tasks**:
1. Add DHCP server operations to SKILL.md:
   - `dhcp-pool-create` - Create IP pool
   - `dhcp-server-create` - Create DHCP server instance
   - `dhcp-network-add` - Configure DHCP network parameters
   - `dhcp-lease-add` - Add static lease
   - `dhcp-server-list` - Query DHCP servers
   - `dhcp-lease-list` - Query active leases
2. Implement output parsers for DHCP queries
3. Add idempotency checks for DHCP operations
4. Create DHCP validation workflow
5. Add DHCP configuration to L1.0 complete workflow

**Reference Commands** (from SKILL.md Phase 2+ section):
```bash
# Create IP pool
ssh admin@192.168.88.1 "/ip pool add name=pool-attic ranges=10.0.0.100-10.0.0.200"

# Create DHCP server
ssh admin@192.168.88.1 "/ip dhcp-server add name=dhcp-attic interface=bridge-attic address-pool=pool-attic disabled=no"

# Configure DHCP network
ssh admin@192.168.88.1 "/ip dhcp-server network add address=10.0.0.0/24 gateway=10.0.0.1 dns-server=10.0.0.1 domain=attic.local"

# Add static lease
ssh admin@192.168.88.1 "/ip dhcp-server lease add address=10.0.0.10 mac-address=XX:XX:XX:XX:XX:XX server=dhcp-attic comment='nux static lease'"
```

**Deliverable**:
- Updated SKILL.md with DHCP operations
- Test validation confirms DHCP operations work

**Time Estimate**: 2-3 hours (implementation + testing)

---

### Step 3: Extend Mikrotik Skill - DNS Operations (Phase 1B Prep)

**Tasks**:
1. Add DNS operations to SKILL.md:
   - `dns-config-show` - Query DNS configuration
   - `dns-server-set` - Configure upstream DNS servers
   - `dns-static-add` - Add static DNS entry
   - `dns-cache-list` - Query DNS cache
2. Implement output parsers for DNS queries
3. Add idempotency checks for DNS operations
4. Create DNS validation workflow
5. Add DNS configuration to L1.0 complete workflow

**Reference Commands** (from SKILL.md Phase 2+ section):
```bash
# Configure DNS servers
ssh admin@192.168.88.1 "/ip dns set servers=1.1.1.1,8.8.8.8 allow-remote-requests=yes"

# Add static DNS entry
ssh admin@192.168.88.1 "/ip dns static add name=nux.attic.local address=10.0.0.10 comment='Attic server'"

# Query DNS configuration
ssh admin@192.168.88.1 "/ip dns print"
```

**Deliverable**:
- Updated SKILL.md with DNS operations
- Test validation confirms DNS operations work

**Time Estimate**: 1-2 hours (implementation + testing)

---

### Step 4: Execute Phase 1B - DHCP/DNS Configuration

**Prerequisites**:
- ✅ Phase 1A complete (basic network operational)
- ✅ Skill extended with DHCP operations (Step 2)
- ✅ Skill extended with DNS operations (Step 3)
- ✅ NUC MAC address identified

**Execution**:
1. Run Phase 1B configuration workflow (see "Configuration Commands" below)
2. Verify DHCP server created and active
3. Verify DNS configuration applied
4. Test DHCP lease: Connect laptop to ether3, should get 10.0.0.100-200 IP
5. Test DNS resolution: `nslookup nux.attic.local 10.0.0.1`

**Deliverable**:
- DHCP server operational (10.0.0.100-200 pool)
- DNS server operational with static entries
- Clients receive automatic IP assignment
- Hostnames resolve via DNS

**Time Estimate**: 1 hour

---

## Configuration Commands

### Phase 1A: Basic Network (Available Today)

**Complete Workflow Script**:
```bash
#!/usr/bin/env bash
set -euo pipefail

# SSH helper function
ssh_exec() {
    ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no admin@192.168.88.1 "$1"
}

# Configuration parameters
BRIDGE_NAME="bridge-attic"
IP_ADDRESS="10.0.0.1/24"
PORTS=("ether1" "ether2" "ether3" "ether4" "ether5" "ether6" "ether7" "ether8")
PORT_COMMENTS=(
    "NUC NIC 1 (management)"
    "NUC NIC 2 (data)"
    "Port 3 (available)"
    "Port 4 (available)"
    "Port 5 (available)"
    "Port 6 (available)"
    "Port 7 (available)"
    "Port 8 (available)"
)

echo "=========================================="
echo "L1.0 Phase 1A: Basic Network Setup"
echo "=========================================="
echo ""

# Step 0: Test connectivity
echo "[STEP 0] Testing SSH connectivity..."
if ! ssh_exec "/system resource print" >/dev/null 2>&1; then
    echo "[ERROR] Cannot connect to 192.168.88.1"
    exit 1
fi
echo "[OK] Connected to RouterOS"
echo ""

# Step 1: Backup configuration
echo "[STEP 1] Backing up current configuration..."
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
ssh_exec "/export file=backup-$TIMESTAMP" >/dev/null
echo "[OK] Backup created: backup-$TIMESTAMP.rsc"
echo ""

# Step 2: Create bridge
echo "[STEP 2] Creating bridge..."
EXISTS=$(ssh_exec "/interface bridge print count-only where name=$BRIDGE_NAME")
if [ "$EXISTS" = "0" ]; then
    ssh_exec "/interface bridge add name=$BRIDGE_NAME vlan-filtering=no comment='Attic server isolated network - 8 port flat bridge'"
    echo "[OK] Bridge $BRIDGE_NAME created"
else
    echo "[OK] Bridge $BRIDGE_NAME already exists (idempotent)"
fi
echo ""

# Step 3: Add ports to bridge
echo "[STEP 3] Adding ports to bridge..."
for i in "${!PORTS[@]}"; do
    PORT="${PORTS[$i]}"
    COMMENT="${PORT_COMMENTS[$i]}"

    EXISTS=$(ssh_exec "/interface bridge port print count-only where bridge=$BRIDGE_NAME and interface=$PORT")
    if [ "$EXISTS" = "0" ]; then
        ssh_exec "/interface bridge port add bridge=$BRIDGE_NAME interface=$PORT comment='$COMMENT'"
        echo "[OK] Added $PORT to $BRIDGE_NAME"
    else
        echo "[OK] Port $PORT already in $BRIDGE_NAME (idempotent)"
    fi
done
echo ""

# Step 4: Add IP address to bridge
echo "[STEP 4] Adding IP address to bridge..."
EXISTS=$(ssh_exec "/ip address print count-only where interface=$BRIDGE_NAME")
if [ "$EXISTS" = "0" ]; then
    ssh_exec "/ip address add address=$IP_ADDRESS interface=$BRIDGE_NAME comment='Attic network gateway and DHCP server'"
    echo "[OK] IP $IP_ADDRESS added to $BRIDGE_NAME"
else
    echo "[OK] IP already assigned to $BRIDGE_NAME (idempotent)"
fi
echo ""

# Step 5: Validate configuration
echo "[STEP 5] Validating configuration..."
BRIDGE_COUNT=$(ssh_exec "/interface bridge print count-only where name=$BRIDGE_NAME")
PORT_COUNT=$(ssh_exec "/interface bridge port print count-only where bridge=$BRIDGE_NAME")
IP_COUNT=$(ssh_exec "/ip address print count-only where interface=$BRIDGE_NAME")

echo "  Bridges: $BRIDGE_COUNT (expected: 1)"
echo "  Ports: $PORT_COUNT (expected: 8)"
echo "  IP addresses: $IP_COUNT (expected: 1)"

if [ "$BRIDGE_COUNT" = "1" ] && [ "$PORT_COUNT" = "8" ] && [ "$IP_COUNT" = "1" ]; then
    echo "[OK] Validation passed"
else
    echo "[ERROR] Validation failed"
    exit 1
fi
echo ""

echo "=========================================="
echo "Phase 1A Configuration Complete!"
echo "=========================================="
echo ""
echo "Summary:"
echo "  Bridge: $BRIDGE_NAME"
echo "  Ports: ${PORTS[*]}"
echo "  IP: $IP_ADDRESS"
echo "  Backup: backup-$TIMESTAMP.rsc"
echo ""
echo "Next steps:"
echo "  1. Configure NUC with static IP 10.0.0.10/24"
echo "  2. Test connectivity: ping 10.0.0.1 from NUC"
echo "  3. Proceed to L1.1 (Infrastructure Survey)"
echo "  OR"
echo "  4. Extend mikrotik-management skill with DHCP/DNS (Phase 1B)"
```

**Manual Execution** (if script unavailable):
```bash
# Connect and test
ssh admin@192.168.88.1

# Backup
/export file=backup-20260127-$(date +%H%M%S)

# Create bridge
/interface bridge add name=bridge-attic vlan-filtering=no comment="Attic server isolated network - 8 port flat bridge"

# Add ports (run for each ether1-ether8)
/interface bridge port add bridge=bridge-attic interface=ether1 comment="NUC NIC 1 (management)"
/interface bridge port add bridge=bridge-attic interface=ether2 comment="NUC NIC 2 (data)"
/interface bridge port add bridge=bridge-attic interface=ether3 comment="Port 3 (available)"
/interface bridge port add bridge=bridge-attic interface=ether4 comment="Port 4 (available)"
/interface bridge port add bridge=bridge-attic interface=ether5 comment="Port 5 (available)"
/interface bridge port add bridge=bridge-attic interface=ether6 comment="Port 6 (available)"
/interface bridge port add bridge=bridge-attic interface=ether7 comment="Port 7 (available)"
/interface bridge port add bridge=bridge-attic interface=ether8 comment="Port 8 (available)"

# Add IP address
/ip address add address=10.0.0.1/24 interface=bridge-attic comment="Attic network gateway and DHCP server"

# Validate
/interface bridge print where name=bridge-attic
/interface bridge port print where bridge=bridge-attic
/ip address print where interface=bridge-attic
```

---

### Phase 1B: DHCP/DNS Configuration (After Skill Enhancement)

**Complete Workflow Script** (template for future use):
```bash
#!/usr/bin/env bash
set -euo pipefail

# SSH helper function
ssh_exec() {
    ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no admin@192.168.88.1 "$1"
}

# Configuration parameters
BRIDGE_NAME="bridge-attic"
DHCP_SERVER_NAME="dhcp-attic"
DHCP_POOL_NAME="pool-attic"
DHCP_POOL_RANGE="10.0.0.100-10.0.0.200"
DHCP_NETWORK="10.0.0.0/24"
DHCP_GATEWAY="10.0.0.1"
DHCP_DNS="10.0.0.1"
DHCP_DOMAIN="attic.local"
DNS_UPSTREAM="1.1.1.1,8.8.8.8"

# NUC static lease (replace with actual MAC address)
NUC_IP="10.0.0.10"
NUC_MAC="XX:XX:XX:XX:XX:XX"  # TODO: Replace with actual NUC MAC
NUC_HOSTNAME="nux.attic.local"

echo "=========================================="
echo "L1.0 Phase 1B: DHCP/DNS Setup"
echo "=========================================="
echo ""

# Step 0: Verify Phase 1A complete
echo "[STEP 0] Verifying Phase 1A completion..."
BRIDGE_EXISTS=$(ssh_exec "/interface bridge print count-only where name=$BRIDGE_NAME")
if [ "$BRIDGE_EXISTS" = "0" ]; then
    echo "[ERROR] Bridge $BRIDGE_NAME not found. Run Phase 1A first."
    exit 1
fi
echo "[OK] Phase 1A complete"
echo ""

# Step 1: Backup configuration
echo "[STEP 1] Backing up current configuration..."
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
ssh_exec "/export file=backup-$TIMESTAMP" >/dev/null
echo "[OK] Backup created: backup-$TIMESTAMP.rsc"
echo ""

# Step 2: Create DHCP IP pool
echo "[STEP 2] Creating DHCP IP pool..."
EXISTS=$(ssh_exec "/ip pool print count-only where name=$DHCP_POOL_NAME")
if [ "$EXISTS" = "0" ]; then
    ssh_exec "/ip pool add name=$DHCP_POOL_NAME ranges=$DHCP_POOL_RANGE"
    echo "[OK] DHCP pool $DHCP_POOL_NAME created ($DHCP_POOL_RANGE)"
else
    echo "[OK] DHCP pool $DHCP_POOL_NAME already exists (idempotent)"
fi
echo ""

# Step 3: Create DHCP server
echo "[STEP 3] Creating DHCP server..."
EXISTS=$(ssh_exec "/ip dhcp-server print count-only where name=$DHCP_SERVER_NAME")
if [ "$EXISTS" = "0" ]; then
    ssh_exec "/ip dhcp-server add name=$DHCP_SERVER_NAME interface=$BRIDGE_NAME address-pool=$DHCP_POOL_NAME disabled=no"
    echo "[OK] DHCP server $DHCP_SERVER_NAME created"
else
    echo "[OK] DHCP server $DHCP_SERVER_NAME already exists (idempotent)"
fi
echo ""

# Step 4: Configure DHCP network
echo "[STEP 4] Configuring DHCP network..."
EXISTS=$(ssh_exec "/ip dhcp-server network print count-only where address=$DHCP_NETWORK")
if [ "$EXISTS" = "0" ]; then
    ssh_exec "/ip dhcp-server network add address=$DHCP_NETWORK gateway=$DHCP_GATEWAY dns-server=$DHCP_DNS domain=$DHCP_DOMAIN"
    echo "[OK] DHCP network configured"
else
    echo "[OK] DHCP network already configured (idempotent)"
fi
echo ""

# Step 5: Add static DHCP lease for NUC
echo "[STEP 5] Adding static DHCP lease for NUC..."
EXISTS=$(ssh_exec "/ip dhcp-server lease print count-only where address=$NUC_IP")
if [ "$EXISTS" = "0" ]; then
    ssh_exec "/ip dhcp-server lease add address=$NUC_IP mac-address=$NUC_MAC server=$DHCP_SERVER_NAME comment='nux static lease'"
    echo "[OK] Static lease added for NUC ($NUC_IP)"
else
    echo "[OK] Static lease already exists for NUC (idempotent)"
fi
echo ""

# Step 6: Configure DNS upstream servers
echo "[STEP 6] Configuring DNS upstream servers..."
ssh_exec "/ip dns set servers=$DNS_UPSTREAM allow-remote-requests=yes"
echo "[OK] DNS upstream servers configured: $DNS_UPSTREAM"
echo ""

# Step 7: Add static DNS entries
echo "[STEP 7] Adding static DNS entries..."
EXISTS=$(ssh_exec "/ip dns static print count-only where name=$NUC_HOSTNAME")
if [ "$EXISTS" = "0" ]; then
    ssh_exec "/ip dns static add name=$NUC_HOSTNAME address=$NUC_IP comment='Attic server'"
    ssh_exec "/ip dns static add name=attic.local address=$NUC_IP comment='Attic server alias'"
    echo "[OK] Static DNS entries added"
else
    echo "[OK] Static DNS entries already exist (idempotent)"
fi
echo ""

# Step 8: Validate configuration
echo "[STEP 8] Validating DHCP/DNS configuration..."
POOL_COUNT=$(ssh_exec "/ip pool print count-only where name=$DHCP_POOL_NAME")
SERVER_COUNT=$(ssh_exec "/ip dhcp-server print count-only where name=$DHCP_SERVER_NAME")
NETWORK_COUNT=$(ssh_exec "/ip dhcp-server network print count-only where address=$DHCP_NETWORK")
LEASE_COUNT=$(ssh_exec "/ip dhcp-server lease print count-only where address=$NUC_IP")
DNS_STATIC_COUNT=$(ssh_exec "/ip dns static print count-only where name=$NUC_HOSTNAME")

echo "  DHCP pools: $POOL_COUNT (expected: 1)"
echo "  DHCP servers: $SERVER_COUNT (expected: 1)"
echo "  DHCP networks: $NETWORK_COUNT (expected: 1)"
echo "  Static leases: $LEASE_COUNT (expected: 1)"
echo "  DNS static entries: $DNS_STATIC_COUNT (expected: ≥1)"

if [ "$POOL_COUNT" = "1" ] && [ "$SERVER_COUNT" = "1" ] && [ "$NETWORK_COUNT" = "1" ] && [ "$LEASE_COUNT" = "1" ]; then
    echo "[OK] Validation passed"
else
    echo "[ERROR] Validation failed"
    exit 1
fi
echo ""

echo "=========================================="
echo "Phase 1B Configuration Complete!"
echo "=========================================="
echo ""
echo "Summary:"
echo "  DHCP server: $DHCP_SERVER_NAME on $BRIDGE_NAME"
echo "  DHCP pool: $DHCP_POOL_RANGE"
echo "  DHCP network: $DHCP_NETWORK"
echo "  DNS upstream: $DNS_UPSTREAM"
echo "  Static lease: $NUC_IP → $NUC_MAC (nux)"
echo "  DNS entries: $NUC_HOSTNAME → $NUC_IP"
echo "  Backup: backup-$TIMESTAMP.rsc"
echo ""
echo "Testing:"
echo "  1. Connect laptop to ether3-ether8"
echo "  2. Should receive IP in range 10.0.0.100-200"
echo "  3. Test DNS: nslookup nux.attic.local 10.0.0.1"
echo "  4. NUC should receive 10.0.0.10 via DHCP (MAC-based)"
```

---

## Option B: Manual DHCP Configuration (Alternative)

If you prefer to configure DHCP manually via RouterOS CLI (bypassing skill enhancement):

**Advantages**:
- Faster time-to-value (today vs 3-4 hours for skill work)
- Unblocks L1.1+ immediately

**Disadvantages**:
- No automation/repeatability
- Manual documentation required
- Future Mikrotik tasks still require skill enhancement

**Commands**:
```bash
# After Phase 1A complete, run these manually:
ssh admin@192.168.88.1

# Create DHCP pool
/ip pool add name=pool-attic ranges=10.0.0.100-10.0.0.200

# Create DHCP server
/ip dhcp-server add name=dhcp-attic interface=bridge-attic address-pool=pool-attic disabled=no

# Configure DHCP network
/ip dhcp-server network add address=10.0.0.0/24 gateway=10.0.0.1 dns-server=10.0.0.1 domain=attic.local

# Add static lease for NUC (replace MAC address)
/ip dhcp-server lease add address=10.0.0.10 mac-address=XX:XX:XX:XX:XX:XX server=dhcp-attic comment="nux static lease"

# Configure DNS
/ip dns set servers=1.1.1.1,8.8.8.8 allow-remote-requests=yes

# Add static DNS entries
/ip dns static add name=nux.attic.local address=10.0.0.10 comment="Attic server"
/ip dns static add name=attic.local address=10.0.0.10 comment="Attic server alias"

# Validate
/ip dhcp-server print
/ip dhcp-server network print
/ip dhcp-server lease print
/ip dns print
/ip dns static print
```

---

## Testing & Validation

### Phase 1A Testing

**Test 1: Bridge and Ports**
```bash
# SSH to switch
ssh admin@192.168.88.1

# Verify bridge
/interface bridge print where name=bridge-attic
# Expected: 1 bridge named "bridge-attic", vlan-filtering=no

# Verify ports
/interface bridge port print where bridge=bridge-attic
# Expected: 8 ports (ether1-ether8) assigned to bridge-attic

# Verify IP
/ip address print where interface=bridge-attic
# Expected: 10.0.0.1/24 assigned to bridge-attic
```

**Test 2: Connectivity**
```bash
# From laptop connected to ether3-ether8:
# 1. Configure static IP: 10.0.0.50/24, gateway 10.0.0.1
# 2. Ping gateway
ping 10.0.0.1

# Expected: Replies from 10.0.0.1 (Mikrotik switch)
```

---

### Phase 1B Testing (After DHCP/DNS Configuration)

**Test 1: DHCP Lease Assignment**
```bash
# From laptop connected to ether3-ether8:
# 1. Configure for DHCP (automatic IP)
# 2. Should receive IP in range 10.0.0.100-200
# 3. Verify:
ip addr show  # Linux
ipconfig      # Windows

# Expected: IP in 10.0.0.100-200, gateway 10.0.0.1, DNS 10.0.0.1
```

**Test 2: DNS Resolution**
```bash
# From laptop with DHCP IP:
nslookup nux.attic.local 10.0.0.1

# Expected:
# Server: 10.0.0.1
# Address: 10.0.0.1#53
# Name: nux.attic.local
# Address: 10.0.0.10
```

**Test 3: NUC Static Lease**
```bash
# From NUC:
# 1. Configure for DHCP (not static IP)
# 2. Should receive 10.0.0.10 (based on MAC address)
# 3. Verify:
ip addr show  # Linux

# Expected: IP 10.0.0.10/24 (not from pool range)
```

**Test 4: Hostname Registration**
```bash
# From switch:
ssh admin@192.168.88.1
/ip dhcp-server lease print

# Expected: NUC lease should show hostname in "host-name" field
# If hostname is "nux", it should appear in lease table

# From laptop:
nslookup nux.attic.local 10.0.0.1

# Expected: Resolves to 10.0.0.10 (NUC)
```

---

## Next Steps

### Immediate (Session 1 - Today)

**Recommended**: Execute Phase 1A only
1. Run Phase 1A configuration script (basic network)
2. Validate bridge, ports, IP address
3. Test connectivity with static IP
4. Document NUC MAC address for Phase 1B
5. Update Plan 013 with L1.0 status: "Phase 1A complete, Phase 1B pending skill enhancement"

**Decision Point**: Choose Option A (skill enhancement) or Option B (manual DHCP config)

---

### Future Sessions

**If Option A (Skill Enhancement)**:
- Session 2: Extend skill with DHCP operations (Step 2)
- Session 3: Extend skill with DNS operations (Step 3)
- Session 4: Execute Phase 1B configuration (Step 4)
- Session 5: Proceed to L1.1 (Infrastructure Survey)

**If Option B (Manual DHCP Config)**:
- Session 2: Execute manual DHCP configuration (see "Option B" section)
- Session 3: Proceed to L1.1 (Infrastructure Survey)
- Future: Return to skill enhancement when time permits

---

## Rollback Procedures

### Rollback Phase 1A
```bash
# SSH to switch
ssh admin@192.168.88.1

# List backups
/file print where name~"backup"

# Restore backup
/import file-name=backup-20260127-HHMMSS.rsc

# Verify rollback
/interface bridge print
/interface bridge port print
/ip address print
```

### Rollback Phase 1B
```bash
# Remove DHCP configuration
/ip dhcp-server network remove [find where address=10.0.0.0/24]
/ip dhcp-server remove [find name=dhcp-attic]
/ip pool remove [find name=pool-attic]

# Remove DNS configuration
/ip dns static remove [find where name~"attic.local"]
/ip dns set servers="" allow-remote-requests=no

# Verify rollback
/ip dhcp-server print
/ip dns print
/ip dns static print
```

---

## Success Criteria

### Phase 1A Complete
- [x] Bridge-attic created with 8 ports
- [x] IP 10.0.0.1/24 assigned to bridge
- [x] Laptop can ping 10.0.0.1 with static IP
- [x] Configuration backed up
- [x] L1.1+ tasks unblocked (NUC uses static IP 10.0.0.10)

### Phase 1B Complete
- [ ] DHCP server operational (pool 10.0.0.100-200)
- [ ] DNS server operational (upstream 1.1.1.1, 8.8.8.8)
- [ ] NUC receives static IP 10.0.0.10 via DHCP (MAC-based)
- [ ] Hostname nux.attic.local resolves to 10.0.0.10
- [ ] Laptops receive DHCP IP and can resolve hostnames
- [ ] Configuration backed up

---

## References

- **Parent Plan**: Plan 013 - `.claude/user-plans/013-distributed-nix-binary-caching.md`
- **Mikrotik Skill**: `home/modules/claude-code/skills/mikrotik-management/SKILL.md`
- **Skill Design**: `home/modules/claude-code/skills/mikrotik-management/REFERENCE.md`
- **Skill Tests**: `home/modules/claude-code/skills/mikrotik-management/test-cases.md`
- **RouterOS Docs**: https://help.mikrotik.com/docs/display/ROS/

---

## Notes

- **Hardware Status**: Mikrotik CRS326-24G-2S+ not currently accessible (L0.3 blocked)
- **Skill Status**: Phase 1 complete (bridge, ports, IP), Phase 2+ (DHCP, DNS) not implemented
- **Recommended Approach**: Execute Phase 1A today, extend skill for Phase 1B in future sessions
- **Alternative Approach**: Execute Phase 1A today, manual DHCP config tomorrow (faster but less repeatable)
