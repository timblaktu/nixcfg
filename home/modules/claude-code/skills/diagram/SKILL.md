---
name: diagram
description: Create, edit, and convert diagrams. Auto-selects format - Mermaid for simple flows/trees, DrawIO for complex architecture/comparisons. Supports .drawio, .drawio.svg, Mermaid, and ASCII input. Use for architecture diagrams, flowcharts, visualizations, or any diagram task.
---

# Diagram Creation and Editing Skill

**Version**: 1.0.0
**Last Updated**: 2026-02-01

## Overview

This skill enables creating and editing diagrams with automatic format selection based on complexity:

| Complexity | Format | Rationale |
|------------|--------|-----------|
| Simple | Mermaid | Text-based, renderer handles layout, works in GitHub/GitLab |
| Complex | DrawIO | Precise spatial control, custom positioning, rich styling |

**Supported Input Formats**:
- `.drawio.svg` - DrawIO with embedded mxGraphModel (PREFERRED)
- `.drawio` - Raw DrawIO XML
- Mermaid code blocks in markdown
- ASCII art diagrams

**Output Formats**:
- Mermaid - for simple diagrams (embedded in markdown)
- `.drawio.svg` - for complex diagrams (ALWAYS with embedded diagram)

---

## Section 1: Format Selection Heuristic

Before creating a diagram, determine the appropriate format:

### Use Mermaid When:

- Linear flows (A → B → C → D)
- Simple trees (2-3 levels max)
- Sequence diagrams
- Basic flowcharts with decision nodes
- Class/ER diagrams without custom positioning
- Diagram will be viewed primarily on GitHub/GitLab

### Use DrawIO When:

- Side-by-side comparisons (Option A vs Option B)
- Multi-region architecture (Frontend/Backend/Database groups)
- Custom spatial layout required
- Layered/stacked architecture views
- User explicitly requests DrawIO
- Precise positioning matters
- Complex styling (gradients, icons, custom colors)

### Decision Flowchart

```
START: User requests diagram
  │
  ├─► Is spatial layout critical?
  │     YES → DrawIO
  │     NO  ↓
  │
  ├─► Multiple interconnected regions?
  │     YES → DrawIO
  │     NO  ↓
  │
  ├─► Side-by-side comparison?
  │     YES → DrawIO
  │     NO  ↓
  │
  ├─► Simple linear/tree structure?
  │     YES → Mermaid
  │     NO  ↓
  │
  └─► Default → Mermaid (simpler is better)
```

---

## Section 2: Creating Mermaid Diagrams

Mermaid diagrams are text-based and let the renderer handle layout.

### Flowchart

```mermaid
flowchart TD
    A[Start] --> B[Process]
    B --> C{Decision}
    C -->|Yes| D[Action 1]
    C -->|No| E[Action 2]
    D --> F[End]
    E --> F
```

**Syntax Notes**:
- `TD` = top-down, `LR` = left-right
- `[]` = rectangle, `{}` = diamond, `()` = rounded, `(())` = circle
- `-->` = arrow, `---` = line, `-.->` = dashed arrow
- `|label|` = edge label

### Sequence Diagram

```mermaid
sequenceDiagram
    participant C as Client
    participant S as Server
    participant D as Database
    C->>S: HTTP Request
    S->>D: Query
    D-->>S: Results
    S-->>C: HTTP Response
```

**Syntax Notes**:
- `->>` = solid arrow (synchronous)
- `-->>` = dashed arrow (response/async)
- `participant X as Label` = named participant

### Entity Relationship

```mermaid
erDiagram
    USER ||--o{ POST : writes
    POST ||--|{ COMMENT : has
    COMMENT }o--|| USER : author
```

**Syntax Notes**:
- `||--o{` = one-to-many
- `||--|{` = one-to-one-or-more
- `}o--||` = many-to-one (optional)

### Best Practices for Mermaid

1. Keep diagrams focused - one concept per diagram
2. Use meaningful node IDs (not just A, B, C)
3. Add labels to edges for clarity
4. Test in GitHub preview before committing

---

## Section 3: Creating DrawIO Diagrams

DrawIO diagrams use mxGraphModel XML for precise control.

### Complete Boilerplate Template

Use this exact template for new `.drawio.svg` files:

```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
     version="1.1" width="850px" height="600px"
     viewBox="-0.5 -0.5 850 600"
     content="&lt;mxfile host=&quot;Claude&quot; modified=&quot;2026-02-01&quot;&gt;&lt;diagram name=&quot;Page-1&quot; id=&quot;diagram-1&quot;&gt;&lt;mxGraphModel dx=&quot;800&quot; dy=&quot;600&quot; grid=&quot;1&quot; gridSize=&quot;10&quot; guides=&quot;1&quot; tooltips=&quot;1&quot; connect=&quot;1&quot; arrows=&quot;1&quot; fold=&quot;1&quot; page=&quot;1&quot; pageScale=&quot;1&quot; pageWidth=&quot;850&quot; pageHeight=&quot;600&quot;&gt;&lt;root&gt;&lt;mxCell id=&quot;0&quot;/&gt;&lt;mxCell id=&quot;1&quot; parent=&quot;0&quot;/&gt;&lt;/root&gt;&lt;/mxGraphModel&gt;&lt;/diagram&gt;&lt;/mxfile&gt;"
     style="background-color: rgb(255, 255, 255);">
  <defs/>
  <!-- SVG body will be generated by drawio-svg-sync -->
  <g>
    <text x="400" y="300" text-anchor="middle" font-size="14">
      Run drawio-svg-sync to render this diagram
    </text>
  </g>
</svg>
```

**CRITICAL**: The `content` attribute contains the HTML-entity-encoded mxGraphModel. This is what makes the file editable in DrawIO.

### Decoded mxGraphModel Structure

When decoded, the content attribute contains:

```xml
<mxfile host="Claude" modified="2026-02-01">
  <diagram name="Page-1" id="diagram-1">
    <mxGraphModel dx="800" dy="600" grid="1" gridSize="10"
                  guides="1" tooltips="1" connect="1" arrows="1"
                  fold="1" page="1" pageScale="1"
                  pageWidth="850" pageHeight="600">
      <root>
        <mxCell id="0"/>                    <!-- Root cell - REQUIRED -->
        <mxCell id="1" parent="0"/>         <!-- Default parent - REQUIRED -->

        <!-- Your shapes and connectors go here -->

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
```

### Invariants (MUST be preserved)

| Invariant | Rule | Consequence if Violated |
|-----------|------|-------------------------|
| Cell 0 | MUST exist, no parent | Diagram won't load |
| Cell 1 | MUST exist, `parent="0"` | Shapes won't render |
| IDs | MUST be unique within diagram | Unpredictable behavior |
| Parent refs | All visible cells have `parent="1"` | Element won't appear |
| vertex/edge | Exactly one of `vertex="1"` or `edge="1"` | Rendering issues |
| mxGeometry | Required child for position/size | Element has no location |

---

## Section 4: Adding Shapes

### Basic Rectangle

```xml
<mxCell id="box-1" value="My Label"
        style="rounded=0;whiteSpace=wrap;html=1;"
        vertex="1" parent="1">
  <mxGeometry x="100" y="100" width="120" height="60" as="geometry"/>
</mxCell>
```

### Rounded Rectangle with Color

```xml
<mxCell id="box-2" value="Success"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
        vertex="1" parent="1">
  <mxGeometry x="100" y="200" width="120" height="60" as="geometry"/>
</mxCell>
```

### Text Box

```xml
<mxCell id="text-1" value="Label Text"
        style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;"
        vertex="1" parent="1">
  <mxGeometry x="100" y="300" width="80" height="30" as="geometry"/>
</mxCell>
```

### Dashed Container (for grouping)

```xml
<mxCell id="container-1" value="Group Name"
        style="rounded=1;whiteSpace=wrap;html=1;dashed=1;dashPattern=8 8;fillColor=none;strokeColor=#00CC66;strokeWidth=2;"
        vertex="1" parent="1">
  <mxGeometry x="80" y="400" width="200" height="150" as="geometry"/>
</mxCell>
```

### Common Style Attributes

| Attribute | Values | Purpose |
|-----------|--------|---------|
| `rounded` | `0`, `1` | Corner style (0=sharp, 1=rounded) |
| `whiteSpace` | `wrap` | Text wrapping |
| `html` | `1` | Enable HTML in labels |
| `fillColor` | `#RRGGBB`, `none` | Background color |
| `strokeColor` | `#RRGGBB` | Border color |
| `strokeWidth` | number | Border thickness |
| `fontColor` | `#RRGGBB` | Text color |
| `fontSize` | number | Font size (points) |
| `fontStyle` | `1` | Bold text |
| `dashed` | `0`, `1` | Dashed border |
| `dashPattern` | `N N` | Dash/gap pattern |

### Color Palette (User Preference)

| Theme | fillColor | strokeColor | Use Case |
|-------|-----------|-------------|----------|
| Green (success) | `#d5e8d4` | `#82b366` | Positive states |
| Red (error) | `#f8cecc` | `#b85450` | Warnings, issues |
| Yellow (warning) | `#fff2cc` | `#d6b656` | Caution, pending |
| Orange | `#ffe6cc` | `#d79b00` | Configuration |
| Purple | `#e1d5e7` | `#9673a6` | Services |
| Blue (light) | `#dae8fc` | `#6c8ebf` | Infrastructure |
| Blue (dark) | `#0050ef` | `#001DBC` | Network |

---

## Section 5: Adding Connectors

### Basic Arrow (Orthogonal Routing)

```xml
<mxCell id="conn-1" value=""
        style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=classic;"
        edge="1" parent="1" source="box-1" target="box-2">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

### Arrow with Label

```xml
<mxCell id="conn-2" value="sends data"
        style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;endArrow=classic;"
        edge="1" parent="1" source="box-1" target="box-2">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

### Explicit Anchor Points

For left-to-right flow (user preference):

```xml
<mxCell id="conn-3" value=""
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;endArrow=classic;html=1;"
        edge="1" parent="1" source="left-box" target="right-box">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

### Anchor Point Reference

```
      (0.5, 0) = top center
           ↓
(0, 0.5) → ┌────────────┐ ← (1, 0.5)
left       │   SHAPE    │   right
center     └────────────┘   center
                ↑
           (0.5, 1) = bottom center
```

| Position | exitX/entryX | exitY/entryY |
|----------|--------------|--------------|
| Left center | 0 | 0.5 |
| Right center | 1 | 0.5 |
| Top center | 0.5 | 0 |
| Bottom center | 0.5 | 1 |

### Floating Edge (No Source/Target)

```xml
<mxCell id="float-1" value=""
        style="endArrow=classic;html=1;"
        edge="1" parent="1">
  <mxGeometry width="50" height="50" relative="1" as="geometry">
    <mxPoint x="100" y="200" as="sourcePoint"/>
    <mxPoint x="300" y="200" as="targetPoint"/>
  </mxGeometry>
</mxCell>
```

### Arrow Styles

| Pattern | Style Attributes |
|---------|-----------------|
| Standard arrow | `endArrow=classic;` |
| Filled triangle | `endArrow=block;endFill=1;` |
| Open arrow | `endArrow=open;` |
| Bidirectional | `startArrow=oval;startFill=1;endArrow=oval;endFill=1;` |
| No arrows | `startArrow=none;endArrow=none;` |
| Dashed line | `dashed=1;dashPattern=8 8;` |

---

## Section 6: Complete Creation Examples

### Example 1: 3-Tier Architecture

**Request**: "Create a 3-tier architecture diagram with Web, API, and Database layers"

**Result** (decoded mxGraphModel, shapes only):

```xml
<!-- Web Tier -->
<mxCell id="web" value="Web Tier"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;"
        vertex="1" parent="1">
  <mxGeometry x="100" y="50" width="120" height="60" as="geometry"/>
</mxCell>

<!-- API Tier -->
<mxCell id="api" value="API Tier"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
        vertex="1" parent="1">
  <mxGeometry x="100" y="150" width="120" height="60" as="geometry"/>
</mxCell>

<!-- Database Tier -->
<mxCell id="db" value="Database"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
        vertex="1" parent="1">
  <mxGeometry x="100" y="250" width="120" height="60" as="geometry"/>
</mxCell>

<!-- Web → API Connector -->
<mxCell id="conn-web-api"
        style="edgeStyle=orthogonalEdgeStyle;exitX=0.5;exitY=1;entryX=0.5;entryY=0;endArrow=classic;html=1;"
        edge="1" parent="1" source="web" target="api">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<!-- API → Database Connector -->
<mxCell id="conn-api-db"
        style="edgeStyle=orthogonalEdgeStyle;exitX=0.5;exitY=1;entryX=0.5;entryY=0;endArrow=classic;html=1;"
        edge="1" parent="1" source="api" target="db">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

### Example 2: Pipeline Workflow (Left-to-Right)

**Request**: "Create a CI/CD pipeline: Fetch → Build → Test → Deploy"

**Result**:

```xml
<!-- Phase boxes - horizontal arrangement -->
<mxCell id="fetch" value="Fetch"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;"
        vertex="1" parent="1">
  <mxGeometry x="50" y="100" width="100" height="60" as="geometry"/>
</mxCell>

<mxCell id="build" value="Build"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
        vertex="1" parent="1">
  <mxGeometry x="200" y="100" width="100" height="60" as="geometry"/>
</mxCell>

<mxCell id="test" value="Test"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
        vertex="1" parent="1">
  <mxGeometry x="350" y="100" width="100" height="60" as="geometry"/>
</mxCell>

<mxCell id="deploy" value="Deploy"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;"
        vertex="1" parent="1">
  <mxGeometry x="500" y="100" width="100" height="60" as="geometry"/>
</mxCell>

<!-- Connectors: exit RIGHT (1, 0.5), enter LEFT (0, 0.5) -->
<mxCell id="conn-1"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;"
        edge="1" parent="1" source="fetch" target="build">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="conn-2"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;"
        edge="1" parent="1" source="build" target="test">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="conn-3"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;"
        edge="1" parent="1" source="test" target="deploy">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

### Example 3: Side-by-Side Comparison

**Request**: "Create a comparison: Before (3 items) vs After (3 items)"

**Result**:

```xml
<!-- Headers -->
<mxCell id="before-header" value="&lt;b&gt;BEFORE&lt;/b&gt;"
        style="text;html=1;align=center;verticalAlign=middle;fontSize=16;"
        vertex="1" parent="1">
  <mxGeometry x="50" y="30" width="150" height="40" as="geometry"/>
</mxCell>

<mxCell id="after-header" value="&lt;b&gt;AFTER&lt;/b&gt;"
        style="text;html=1;align=center;verticalAlign=middle;fontSize=16;"
        vertex="1" parent="1">
  <mxGeometry x="350" y="30" width="150" height="40" as="geometry"/>
</mxCell>

<!-- Before column -->
<mxCell id="before-1" value="Manual process"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;"
        vertex="1" parent="1">
  <mxGeometry x="50" y="100" width="150" height="50" as="geometry"/>
</mxCell>

<mxCell id="before-2" value="Slow deployment"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;"
        vertex="1" parent="1">
  <mxGeometry x="50" y="170" width="150" height="50" as="geometry"/>
</mxCell>

<mxCell id="before-3" value="Error-prone"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;"
        vertex="1" parent="1">
  <mxGeometry x="50" y="240" width="150" height="50" as="geometry"/>
</mxCell>

<!-- After column -->
<mxCell id="after-1" value="Automated CI/CD"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
        vertex="1" parent="1">
  <mxGeometry x="350" y="100" width="150" height="50" as="geometry"/>
</mxCell>

<mxCell id="after-2" value="Fast deployment"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
        vertex="1" parent="1">
  <mxGeometry x="350" y="170" width="150" height="50" as="geometry"/>
</mxCell>

<mxCell id="after-3" value="Reliable"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
        vertex="1" parent="1">
  <mxGeometry x="350" y="240" width="150" height="50" as="geometry"/>
</mxCell>

<!-- Transformation arrows -->
<mxCell id="transform-1"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;dashed=1;"
        edge="1" parent="1" source="before-1" target="after-1">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="transform-2"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;dashed=1;"
        edge="1" parent="1" source="before-2" target="after-2">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>

<mxCell id="transform-3"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;dashed=1;"
        edge="1" parent="1" source="before-3" target="after-3">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

---

## Section 7: Coordinate System

### Basics

- Origin: Top-left corner (0, 0)
- X-axis: Increases rightward
- Y-axis: Increases downward
- Units: Pixels

### mxGeometry Attributes

```xml
<mxGeometry x="100" y="200" width="120" height="60" as="geometry"/>
```

| Attribute | Purpose |
|-----------|---------|
| `x` | Left edge position |
| `y` | Top edge position |
| `width` | Element width |
| `height` | Element height |
| `as` | Always `"geometry"` |

### Parent-Child Coordinates

When `parent="1"` (default): coordinates are **ABSOLUTE**.

When `parent="other-id"` (container): coordinates are **RELATIVE** to parent.

```xml
<!-- Parent at absolute (100, 200) -->
<mxCell id="container" ... parent="1">
  <mxGeometry x="100" y="200" width="200" height="150" as="geometry"/>
</mxCell>

<!-- Child at relative (20, 30) = absolute (120, 230) -->
<mxCell id="child" ... parent="container">
  <mxGeometry x="20" y="30" width="80" height="40" as="geometry"/>
</mxCell>
```

### Layout Guidelines (User Preferences)

| Preference | Implementation |
|------------|----------------|
| Arrows enter LEFT | `entryX=0;entryY=0.5;` |
| Arrows exit RIGHT | `exitX=1;exitY=0.5;` |
| Use grid multiples | x, y, width, height in multiples of 10 |
| Consistent spacing | 50px gaps between shapes |

---

## Section 8: Rendering Workflow

After creating or editing the mxGraphModel XML, you MUST render it to update the visible SVG body.

### Pre-Render Validation Checklist

Before running the renderer, verify your XML:

- [ ] Cell 0 exists with no `parent` attribute
- [ ] Cell 1 exists with `parent="0"`
- [ ] All element IDs are unique
- [ ] All edges have valid `source`/`target` IDs (or explicit sourcePoint/targetPoint)
- [ ] All shapes have `vertex="1" parent="1"`
- [ ] All edges have `edge="1" parent="1"`
- [ ] All shapes have `<mxGeometry>` with x, y, width, height
- [ ] The `content` attribute is properly HTML-entity-encoded
- [ ] No unclosed XML tags

### Step 1: Create/Edit the .drawio.svg File

Write the complete SVG with encoded mxGraphModel in the `content` attribute.

### Step 2: Run drawio-svg-sync

```bash
nix run 'github:timblaktu/drawio-svg-sync' -- path/to/diagram.drawio.svg
```

**What drawio-svg-sync does**:
1. Reads the mxGraphModel from `content` attribute
2. Launches headless DrawIO in a Docker container
3. Renders the diagram to SVG elements
4. Replaces the SVG body with rendered graphics
5. Preserves the `content` attribute (keeps it editable in DrawIO)

**Expected success output**:
```
Processing: path/to/diagram.drawio.svg
Rendering diagram...
Successfully updated SVG body
```

**Expected runtime**: 5-15 seconds (Docker container startup + rendering)

### Step 3: Verify Rendering Success

#### Quick Verification

```bash
# Check file was modified (mtime should be recent)
ls -la path/to/diagram.drawio.svg

# Confirm SVG body was regenerated (should see actual shapes, not placeholder)
rg '<rect |<path |<ellipse ' path/to/diagram.drawio.svg | head -5
```

**Success indicators**:
- File modification time updated
- SVG body contains `<rect>`, `<path>`, `<g>`, etc. (actual graphics)
- Placeholder text ("Run drawio-svg-sync...") is gone

#### Detailed Verification (Optional)

```bash
# View in browser to confirm visual correctness
xdg-open path/to/diagram.drawio.svg

# Check the file opens in DrawIO desktop (confirms content attribute valid)
drawio path/to/diagram.drawio.svg
```

### Post-Render Validation Checklist

After successful rendering:

- [ ] File modification time updated
- [ ] SVG body contains actual graphic elements (not placeholder)
- [ ] Diagram displays correctly in browser
- [ ] Diagram opens in DrawIO desktop without errors
- [ ] Expected elements visible (shapes, connectors, labels)
- [ ] Colors and styling match intent

### Step 4: Git Workflow Integration

#### Staging

The `.drawio.svg` file is self-contained - it includes both:
- The encoded mxGraphModel (source of truth, editable in DrawIO)
- The rendered SVG body (visual representation)

Stage the single file:
```bash
git add path/to/diagram.drawio.svg
```

**Important**: Never stage intermediate states. Only stage after successful rendering.

#### Commit Message Conventions

Follow this pattern for diagram commits:

```bash
# For new diagrams
git commit -m "Add diagram: <what it shows>

<Brief description of purpose/context>"

# For diagram edits
git commit -m "Update diagram: <what changed>

<Why the change was made>"
```

**Examples**:
```bash
git commit -m "Add diagram: 3-tier architecture overview

Shows Web, API, and Database layers with connectivity"

git commit -m "Update diagram: rename 'Fetch' to 'Download' phase

Aligns terminology with upstream documentation"

git commit -m "Update diagram: add Cache component between API and Database

Illustrates caching layer for performance discussion"
```

#### PR Description (if applicable)

When diagram changes are part of a PR:
1. Mention the diagram change in the PR summary
2. Note what the diagram shows (GitHub/GitLab render .drawio.svg inline)
3. If the change is visual-only, say so ("no functional changes")

### Error Handling: Common Failures and Recovery

#### Failure: Docker Not Running

**Symptoms**:
```
Error: Cannot connect to Docker daemon
Error: docker: command not found
```

**Recovery**:
```bash
# Start Docker
sudo systemctl start docker

# Or, if using Docker Desktop
# Open Docker Desktop application

# Retry
nix run 'github:timblaktu/drawio-svg-sync' -- path/to/diagram.drawio.svg
```

#### Failure: Invalid XML in content Attribute

**Symptoms**:
```
Error: Failed to parse mxGraphModel
Error: XML parsing error at line X
```

**Recovery**:
1. Decode the content attribute
2. Validate XML (look for unclosed tags, mismatched quotes)
3. Common issues:
   - Unescaped `&` (should be `&amp;`)
   - Unescaped `<` in label text (should be `&lt;`)
   - Missing closing `</mxCell>`
4. Fix the XML, re-encode, and retry

#### Failure: Missing Required Cells

**Symptoms**:
```
Error: Root cell not found
Error: Default parent cell missing
```

**Recovery**:
Ensure your mxGraphModel has the required structure:
```xml
<root>
  <mxCell id="0"/>                    <!-- REQUIRED -->
  <mxCell id="1" parent="0"/>         <!-- REQUIRED -->
  <!-- Your shapes here -->
</root>
```

#### Failure: Duplicate IDs

**Symptoms**:
- Diagram loads but elements overlap unexpectedly
- Some elements don't appear
- DrawIO shows warnings about duplicate IDs

**Recovery**:
```bash
# Find duplicate IDs
rg -o 'id="[^"]+"' path/to/diagram.drawio.svg | sort | uniq -d
```
Rename duplicates to unique values.

#### Failure: Invalid Edge References

**Symptoms**:
- Edges don't appear
- Edges appear disconnected (floating)

**Recovery**:
```bash
# List all source/target references
rg 'source="([^"]+)"|target="([^"]+)"' -o path/to/diagram.drawio.svg

# List all shape IDs
rg 'id="([^"]+)".*vertex="1"' -o path/to/diagram.drawio.svg
```
Ensure every `source` and `target` value matches an existing shape ID.

#### Failure: Encoding Issues

**Symptoms**:
- File appears corrupted after editing
- `content` attribute truncated
- Special characters rendered incorrectly

**Recovery**:
Verify encoding is correct:
- `<` → `&lt;`
- `>` → `&gt;`
- `"` → `&quot;`
- `&` → `&amp;`
- Newlines → `&#10;`

Do NOT double-encode (e.g., `&amp;lt;` is wrong, should be `&lt;`).

### Workflow Summary

```
┌─────────────────────────────────────────────────────────┐
│                    RENDERING WORKFLOW                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  1. Edit mxGraphModel XML                               │
│     └─► Pre-render checklist ✓                          │
│                                                          │
│  2. Re-encode content attribute                         │
│     └─► HTML entities properly escaped                  │
│                                                          │
│  3. Run drawio-svg-sync                                 │
│     └─► nix run 'github:timblaktu/drawio-svg-sync' -- FILE │
│                                                          │
│  4. Verify success                                      │
│     └─► Post-render checklist ✓                         │
│                                                          │
│  5. Stage and commit                                    │
│     └─► git add FILE && git commit -m "..."             │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## Section 9: Encoding the content Attribute

When writing a `.drawio.svg` file, the mxGraphModel must be HTML-entity-encoded in the `content` attribute.

### Encoding Rules

| Character | Encoded |
|-----------|---------|
| `<` | `&lt;` |
| `>` | `&gt;` |
| `"` | `&quot;` |
| `&` | `&amp;` |
| newline | `&#10;` |

### Example Encoding

**Before** (raw XML):
```xml
<mxfile host="Claude">
  <diagram name="Page-1" id="1">
    <mxGraphModel>
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
```

**After** (for content attribute):
```
&lt;mxfile host=&quot;Claude&quot;&gt;&#10;  &lt;diagram name=&quot;Page-1&quot; id=&quot;1&quot;&gt;&#10;    &lt;mxGraphModel&gt;&#10;      &lt;root&gt;&#10;        &lt;mxCell id=&quot;0&quot;/&gt;&#10;        &lt;mxCell id=&quot;1&quot; parent=&quot;0&quot;/&gt;&#10;      &lt;/root&gt;&#10;    &lt;/mxGraphModel&gt;&#10;  &lt;/diagram&gt;&#10;&lt;/mxfile&gt;
```

### Implementation Pattern

When creating a new diagram:

1. Build the mxGraphModel XML structure
2. Encode special characters
3. Insert into `content="..."` attribute
4. Include placeholder SVG body
5. Run drawio-svg-sync to render

---

## Quick Reference Card

### New Diagram Checklist

- [ ] Cell 0 exists (no parent attribute)
- [ ] Cell 1 exists (parent="0")
- [ ] All shapes have unique IDs
- [ ] All shapes have `vertex="1" parent="1"`
- [ ] All shapes have `<mxGeometry>` child
- [ ] All edges have `edge="1" parent="1"`
- [ ] All edges have source/target OR sourcePoint/targetPoint
- [ ] content attribute is properly encoded
- [ ] Run drawio-svg-sync after editing

### Minimal Shape

```xml
<mxCell id="UNIQUE_ID" value="LABEL"
        style="rounded=1;whiteSpace=wrap;html=1;"
        vertex="1" parent="1">
  <mxGeometry x="X" y="Y" width="W" height="H" as="geometry"/>
</mxCell>
```

### Minimal Connector

```xml
<mxCell id="UNIQUE_ID"
        style="edgeStyle=orthogonalEdgeStyle;endArrow=classic;html=1;"
        edge="1" parent="1" source="FROM_ID" target="TO_ID">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

For detailed technical reference on shapes, styles, and patterns, see [REFERENCE.md](REFERENCE.md).

---

## Section 10: Editing Existing Diagrams

When editing an existing `.drawio.svg` file, follow this workflow to make surgical changes without breaking the diagram.

### Step 1: Format Detection

First, determine what kind of file you're editing:

```bash
# Check for content attribute (DrawIO format)
rg -o 'content="[^"]{0,50}' file.drawio.svg
```

**DrawIO Format** (has `content` attribute with mxfile):
- The `content` attribute contains the editable mxGraphModel
- SVG body is just rendered output (regenerated by drawio-svg-sync)
- Edit the XML inside `content`, not the SVG elements

**Pure SVG** (no `content` attribute, or content doesn't contain mxfile):
- Out of scope for this skill
- These are hand-crafted SVGs, not DrawIO diagrams
- Inform user and decline to edit

### Step 2: Extract and Decode the mxGraphModel

The `content` attribute is HTML-entity-encoded. To edit:

1. **Extract** the content attribute value
2. **Decode** HTML entities:
   - `&lt;` → `<`
   - `&gt;` → `>`
   - `&quot;` → `"`
   - `&amp;` → `&`
   - `&#10;` → newline
3. **Parse** as XML to find target elements

### Step 3: Find Target Elements

#### By Text Content (User-Friendly)

Users think in terms of labels, not IDs. Search by `value` attribute:

```xml
<!-- Looking for "Fetch" -->
<mxCell id="phase-1" value="Fetch" .../>
```

**Pattern**: `value="TARGET_TEXT"` or `value="&lt;b&gt;TARGET_TEXT&lt;/b&gt;"` (HTML formatted)

**Caution**: Text might be HTML-encoded within the value:
- `&lt;b&gt;Title&lt;/b&gt;` = bold text
- `&lt;br&gt;` = line break

#### By ID (Precise)

When you know the exact ID:

```xml
<mxCell id="exact-id" .../>
```

**Pattern**: `id="TARGET_ID"`

#### By Style (Type-Based)

Find all shapes of a certain type:

```xml
<!-- All containers -->
<mxCell ... style="...container=1..." .../>

<!-- All edges -->
<mxCell ... edge="1" .../>

<!-- All vertices (shapes) -->
<mxCell ... vertex="1" .../>
```

### Step 4: Modify Text (value Attribute)

**SAFE**: Change only the `value` attribute, preserve everything else.

**Before**:
```xml
<mxCell id="step-1" value="Fetch"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;"
        vertex="1" parent="1">
  <mxGeometry x="50" y="100" width="100" height="60" as="geometry"/>
</mxCell>
```

**After** (changing "Fetch" to "Download"):
```xml
<mxCell id="step-1" value="Download"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;"
        vertex="1" parent="1">
  <mxGeometry x="50" y="100" width="100" height="60" as="geometry"/>
</mxCell>
```

**Verification**: The diff should show ONLY the value change:
```diff
-<mxCell id="step-1" value="Fetch"
+<mxCell id="step-1" value="Download"
```

### Step 5: Modify Style Attributes

The `style` attribute is a semicolon-separated key=value string. To modify:

1. Parse into key-value pairs
2. Update specific keys
3. Rebuild the string
4. Preserve key order when possible

**Example: Change fill color to light green**

**Before**:
```
style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;"
```

**After**:
```
style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
```

**Common Style Modifications**:

| Goal | Key(s) to Modify |
|------|-----------------|
| Change background color | `fillColor=#RRGGBB` |
| Change border color | `strokeColor=#RRGGBB` |
| Make dashed | `dashed=1;dashPattern=8 8;` |
| Make bold text | `fontStyle=1;` |
| Change font size | `fontSize=14;` |
| Remove fill | `fillColor=none;` |
| Add rounded corners | `rounded=1;` |

**Caution**: Some keys are flags (presence = true). Don't add `=1` unnecessarily:
- `html=1` ✓
- `dashed=1` ✓
- `text;` (no value - it's a shape type flag) ✓

### Step 6: Move Elements (Update Position)

To move an element, update the `x` and `y` attributes in `<mxGeometry>`:

**Before** (at position 100, 200):
```xml
<mxCell id="box-1" ...>
  <mxGeometry x="100" y="200" width="120" height="60" as="geometry"/>
</mxCell>
```

**After** (moved to 250, 150):
```xml
<mxCell id="box-1" ...>
  <mxGeometry x="250" y="150" width="120" height="60" as="geometry"/>
</mxCell>
```

**Important**: If moving a connected shape:
- Edges with `source` or `target` referencing this ID will auto-update endpoints
- Floating edges (using sourcePoint/targetPoint) will NOT update - you must manually adjust

### Step 7: Resize Elements

To resize, update `width` and `height` in `<mxGeometry>`:

**Before**:
```xml
<mxGeometry x="100" y="100" width="120" height="60" as="geometry"/>
```

**After** (larger):
```xml
<mxGeometry x="100" y="100" width="180" height="80" as="geometry"/>
```

**Text Consideration**: If the element has `whiteSpace=wrap;html=1;`, text will reflow to new size. Without wrapping, text may overflow.

### Step 8: Add New Elements

When adding elements to an existing diagram:

1. **Generate unique ID** - check existing IDs, use descriptive names
2. **Set parent="1"** for top-level elements
3. **Include vertex="1" or edge="1"** as appropriate
4. **Provide complete mxGeometry**

**Adding a Shape**:

```xml
<!-- Add after existing mxCell elements, before </root> -->
<mxCell id="new-box" value="New Component"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;"
        vertex="1" parent="1">
  <mxGeometry x="300" y="200" width="120" height="60" as="geometry"/>
</mxCell>
```

**Adding a Connector**:

```xml
<mxCell id="new-conn"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;"
        edge="1" parent="1" source="existing-box" target="new-box">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

**Verify References**: Ensure `source` and `target` IDs exist in the diagram!

### Step 9: Delete Elements Safely

Deleting requires removing the element AND cleaning up references.

#### Delete a Shape

1. Remove the `<mxCell>` element
2. Find ALL edges that reference this ID
3. Remove those edges too (or update their source/target)

**Example**: Deleting "box-to-remove"

**Step 1 - Find connected edges**:
```bash
rg 'source="box-to-remove"|target="box-to-remove"' file.drawio.svg
```

**Step 2 - Remove the shape and ALL referencing edges**:
```xml
<!-- REMOVE these: -->
<mxCell id="box-to-remove" ... vertex="1" .../>
<mxCell id="edge-to-box" ... source="other" target="box-to-remove" edge="1"/>
<mxCell id="edge-from-box" ... source="box-to-remove" target="other" edge="1"/>
```

#### Delete an Edge

Simpler - just remove the `<mxCell>` with `edge="1"`:

```xml
<!-- REMOVE: -->
<mxCell id="edge-to-remove" ... edge="1" .../>
```

**No cascading cleanup needed** - edges don't have dependents.

### Step 10: Preserve Diagram Integrity

**CRITICAL RULES - Never Violate These**:

| Rule | Consequence if Violated |
|------|------------------------|
| Never delete cell 0 | Diagram won't load |
| Never delete cell 1 | Shapes won't render |
| Never duplicate IDs | Unpredictable behavior |
| Never orphan edge references | Edge won't render |
| Never remove mxGeometry | Shape has no location |
| Never break parent references | Element won't appear |

**Pre-Edit Checklist**:
- [ ] Confirmed file has `content` attribute with mxfile
- [ ] Identified target element(s) by text or ID
- [ ] Noted any connected edges (if deleting/moving)
- [ ] Planned minimal changes (don't change what you don't need to)

**Post-Edit Checklist**:
- [ ] Cells 0 and 1 still exist
- [ ] All IDs remain unique
- [ ] All edge source/target references point to existing cells
- [ ] All cells have parent references
- [ ] Re-encoded content attribute properly
- [ ] Run drawio-svg-sync to verify rendering

### Complete Editing Example

**Request**: "In the pipeline diagram, change 'Build' to 'Compile' and make it green"

**Step 1**: Read and decode the content attribute

**Step 2**: Find the target element
```xml
<mxCell id="build" value="Build"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;"
        vertex="1" parent="1">
  <mxGeometry x="200" y="100" width="100" height="60" as="geometry"/>
</mxCell>
```

**Step 3**: Make surgical changes (value and style only)
```xml
<mxCell id="build" value="Compile"
        style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
        vertex="1" parent="1">
  <mxGeometry x="200" y="100" width="100" height="60" as="geometry"/>
</mxCell>
```

**Step 4**: Re-encode and update content attribute

**Step 5**: Run drawio-svg-sync

**Step 6**: Verify the diff shows only expected changes

---

## Section 11: Splitting and Rerouting Connectors

When adding an element "between" two connected elements, you need to handle the existing connector.

### Scenario: Add Element Between Two Connected Elements

**Original**: Box A → Box B (via edge-1)
**Goal**: Box A → New Box → Box B

**Approach 1: Split the Existing Edge** (recommended)

1. **Update edge-1** to connect A → New Box
2. **Add edge-2** to connect New Box → B

```xml
<!-- Modified edge-1: now ends at new-box instead of B -->
<mxCell id="edge-1" ...
        source="box-a" target="new-box" edge="1">
  ...
</mxCell>

<!-- New edge: new-box to B -->
<mxCell id="edge-2"
        style="edgeStyle=orthogonalEdgeStyle;exitX=1;exitY=0.5;entryX=0;entryY=0.5;endArrow=classic;html=1;"
        edge="1" parent="1" source="new-box" target="box-b">
  <mxGeometry relative="1" as="geometry"/>
</mxCell>
```

**Approach 2: Delete and Recreate** (cleaner for complex routing)

1. Delete edge-1 entirely
2. Create edge-1-new: A → New Box
3. Create edge-2-new: New Box → B

### Connector Waypoint Considerations

If the original edge has custom waypoints:
```xml
<mxGeometry relative="1" as="geometry">
  <Array as="points">
    <mxPoint x="200" y="100"/>
    <mxPoint x="200" y="300"/>
  </Array>
</mxGeometry>
```

You may need to:
- Clear waypoints (let orthogonal routing recalculate)
- Or manually adjust waypoints to route around the new element

**Safest approach**: Remove waypoints, let drawio-svg-sync recalculate:
```xml
<mxGeometry relative="1" as="geometry"/>
```

---

## Section 12: Common Editing Patterns

### Pattern 1: Rename Multiple Elements

When renaming a concept across the diagram (e.g., "Server" → "API Gateway"):

1. Find all occurrences: `rg 'value="[^"]*Server[^"]*"'`
2. Update each value attribute
3. Do NOT change IDs (would break edge references)

### Pattern 2: Change Color Scheme

To recolor all elements of a type:

1. Identify elements by current fillColor
2. Search: `fillColor=#dae8fc` (current blue)
3. Replace with: `fillColor=#d5e8d4` (new green)
4. Update strokeColor to match

### Pattern 3: Reposition a Group

When multiple elements need to move together:

1. Calculate the offset (new position - current position)
2. Add offset to each element's x and y
3. Edges with source/target references auto-update

**Example**: Move everything right by 100px
```
x="100" → x="200"
x="250" → x="350"
```

### Pattern 4: Convert Edge Style

Change from straight to orthogonal routing:

**Before**:
```
style="endArrow=classic;html=1;"
```

**After**:
```
style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=classic;"
```

---

## Section 13: Editing Troubleshooting

### Problem: Element Not Visible After Edit

**Check**:
- Does element have `parent="1"` (or valid parent)?
- Does element have `vertex="1"` or `edge="1"`?
- Does element have `<mxGeometry>` with valid x, y, width, height?
- Are coordinates within the page bounds?

### Problem: Edge Not Connecting

**Check**:
- Do `source` and `target` IDs exist?
- Does edge have `edge="1"` attribute?
- Is mxGeometry present (even if minimal)?

### Problem: Diagram Won't Load in DrawIO

**Check**:
- Cell 0 exists with no parent attribute
- Cell 1 exists with `parent="0"`
- All IDs are unique
- XML is valid (no unclosed tags)
- content attribute is properly encoded

### Problem: Changes Not Visible After Sync

**Check**:
- Did you modify the `content` attribute (not just SVG body)?
- Is the content attribute properly encoded?
- Did drawio-svg-sync run without errors?

### Problem: Connector Routing Looks Wrong

**Solution**: Clear waypoints to let DrawIO recalculate:
```xml
<!-- Remove Array as="points" if present -->
<mxGeometry relative="1" as="geometry"/>
```

Then run drawio-svg-sync to regenerate routing.
