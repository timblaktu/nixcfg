# MCP Server Troubleshooting Guide

## Overview
This guide documents common issues and solutions for MCP (Model Context Protocol) servers in the Nix-managed Claude Code configuration.

## Quick Diagnostics

### 1. Check if MCP servers are visible in Claude Code
```bash
# For Pro account
CLAUDE_CONFIG_DIR="/home/tim/.claude-pro" claudepro --print "/mcp"

# For Max account  
CLAUDE_CONFIG_DIR="/home/tim/.claude-max" claudemax --print "/mcp"
```

### 2. Verify MCP server configuration files
```bash
# Check settings.json (should have mcpServers)
cat ~/.claude-pro/settings.json | jq '.mcpServers'

# Check .claude.json (may have mcpServers or null)
cat ~/.claude-pro/.claude.json | jq '.mcpServers'
```

### 3. Test individual MCP servers
```bash
# Test sequential-thinking wrapper
which sequential-thinking-mcp

# Test context7
npx -y @upstash/context7-mcp --help

# Test CLI server path
ls -la /nix/store/*cli-mcp-server*/bin/
```

## Common Issues and Solutions

### Issue 1: MCP servers not showing in /mcp command
**Symptoms**: Running `/mcp` in Claude Code shows no servers or empty list

**Root Cause**: Claude Code periodically overwrites `.claude.json`, removing `mcpServers`

**Permanent Fix (Implemented 2025-01-27)**:
The activation script now automatically replaces MCP servers and all Nix-managed settings on every `home-manager switch`.
Simply run:
```bash
home-manager switch --flake '.#tim@tblack-t14-nixos'
```

This enforces:
- mcpServers (MCP server configurations)
- permissions (allow/deny security rules)
- env (environment variables)
- statusLine (custom statusline configuration)
- hooks (automation hooks)

**Manual Fix (if needed immediately)**:
```bash
# Re-inject MCP servers into .claude.json
cat ~/.claude-pro/.claude.json | jq '. + {
  "mcpServers": {
    "cli-mcp-server": {
      "args": [],
      "command": "/nix/store/gf9qmzr5m8mpis8m6rzydc9dqby8l9d5-cli-mcp-server-env/bin/cli-mcp-server",
      "env": {"ALLOWED_DIR": "/tmp", "DEBUG": "", "NODE_ENV": "production"},
      "retries": 3,
      "timeout": 300
    },
    "context7": {
      "args": ["-y", "@upstash/context7-mcp"],
      "command": "npx",
      "env": {"DEBUG": "", "NODE_ENV": "production"},
      "retries": 3,
      "timeout": 300
    },
    "sequential-thinking": {
      "args": [],
      "command": "sequential-thinking-mcp",
      "env": {"DEBUG": "", "NODE_ENV": "production"},
      "retries": 3,
      "timeout": 600
    }
  }
}' > ~/.claude-pro/.claude.json.tmp && mv ~/.claude-pro/.claude.json.tmp ~/.claude-pro/.claude.json
```

### Issue 2: Sequential-thinking server not found
**Symptoms**: Error about sequential-thinking-mcp command not found

**Check**:
```bash
# Verify wrapper script installed
which sequential-thinking-mcp
ls -la ~/.nix-profile/bin/sequential-thinking-mcp

# Check if Python environment is correct
/nix/store/*sequential-thinking*/bin/python -c "import sequential_thinking_mcp"
```

**Fix**: Run `home-manager switch` to ensure wrapper script is installed

### Issue 3: Context7 fails to start
**Symptoms**: Context7 MCP server errors or doesn't appear

**Check**:
```bash
# Test npx availability
npx -y @upstash/context7-mcp --version

# Check npm/node installation
which npm
which node
```

**Fix**: Ensure nodejs is in system packages or home.packages

### Issue 4: CLI MCP server permission errors
**Symptoms**: CLI server can't access directories

**Check**:
```bash
# Verify ALLOWED_DIR is set correctly
cat ~/.claude-pro/settings.json | jq '.mcpServers."cli-mcp-server".env.ALLOWED_DIR'
```

**Fix**: Update ALLOWED_DIR in the Nix configuration to include needed paths

## File Locations

### Configuration Files
- **Settings**: `~/.claude-{pro,max}/settings.json` - User-editable settings
- **Runtime State**: `~/.claude-{pro,max}/.claude.json` - Claude Code runtime data (volatile!)
- **Memory**: `~/src/nixcfg/claude-runtime/.claude-{pro,max}/CLAUDE.md` - Global memory
- **MCP Template**: Generated by Nix in `/nix/store/*/claude-settings.json`

### Log Files
- **Claude Code logs**: `~/.claude-{pro,max}/logs/`
- **MCP server logs**: Check individual server documentation
- **Activation logs**: Run `home-manager switch` with `--verbose`

## Configuration Hierarchy

Claude Code checks configuration in this order:
1. `.claude.json` - Runtime state + configuration (highest priority)
2. `settings.json` - User settings
3. `mcp.json` - Legacy MCP configuration (deprecated)
4. Project overrides - `.claude/settings.json` in project root

**Important**: `.claude.json` is volatile and gets overwritten by Claude Code!

## Testing MCP Servers

### Manual Server Test
```bash
# Test sequential-thinking directly
echo '{"jsonrpc":"2.0","method":"initialize","params":{"capabilities":{}},"id":1}' | sequential-thinking-mcp

# Test context7
echo '{"jsonrpc":"2.0","method":"initialize","params":{"capabilities":{}},"id":1}' | npx -y @upstash/context7-mcp
```

### Debug Mode
Enable debug output by setting in settings.json:
```json
{
  "mcpServers": {
    "your-server": {
      "env": {
        "DEBUG": "1"
      }
    }
  }
}
```

## Recovery Procedures

### Full Reset
```bash
# Backup current state
cp -r ~/.claude-pro ~/.claude-pro.backup

# Remove all configuration
rm -rf ~/.claude-pro

# Rebuild from Nix
home-manager switch

# Restart Claude Code
```

### Selective Fix
```bash
# Just fix MCP servers
home-manager switch

# Re-inject MCP config (use script from Issue 1 above)

# Restart Claude Code or reload window
```

## Architecture Notes

### Why MCP servers disappear
1. Claude Code maintains runtime state in `.claude.json`
2. Periodically rewrites this file with current state
3. Does NOT preserve `mcpServers` section during rewrite
4. Our activation script preserves the file to not lose oauth/projects

### Design Decisions
- **Wrapper scripts**: Avoid Python package conflicts
- **Direct store paths**: Ensure reproducible server locations  
- **Separate accounts**: Enable concurrent Pro/Max sessions
- **Settings.json preservation**: Allow runtime modifications

## Future Improvements

1. **âœ… COMPLETED**: Activation script replaces all Nix-managed settings while preserving runtime data (2025-01-27)
2. **Optional**: Systemd timer for additional robustness (not needed with current solution)
3. **Optional**: Hook system integration (unnecessary complexity)
4. **Upstream**: Request Claude Code to preserve mcpServers in .claude.json writes

## Implementation Notes

### Why Replacement Not Merge?
The activation script uses **replacement** (`jq '.mcpServers = $value'`) rather than **merge** (`jq '. + {...}'`) for Nix-managed settings. This ensures:
- Removed MCP servers are actually deleted
- Changed configurations take effect immediately
- No stale settings persist from previous configurations

### Safe JSON Handling
The script uses `jq --argjson` to safely pass JSON with special characters:
```bash
jq --argjson mcpServers '${builtins.toJSON cfg.mcpServers}' '.mcpServers = $mcpServers'
```
This handles parentheses, wildcards, and other special characters in permissions and other settings.

## Related Documentation

- `CLAUDE.md` - Main configuration status and roadmap
- `home/modules/claude-code.nix` - Nix module implementation
- `claude-runtime/.claude-*/CLAUDE.md` - Account-specific memory